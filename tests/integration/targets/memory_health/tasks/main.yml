---
- name: Starting Memory health check integration tests
  ansible.builtin.debug:
    msg: "START network.healthchecks.memory health check integration tests on connection={{ ansible_connection }}"

- name: Run memory health check validated content operation
  block:
    - name: Run network.memory validated content with memory health check operation
      ansible.builtin.include_role:
        name: network.healthchecks.memory
      vars:
        critical_threshold: 90
        warning_threshold: 85
        min_free_memory_mb: 100
        min_buffers_mb: 50
        min_cache_mb: 50
      register: memory_result

    - name: Assert memory health check results
      ansible.builtin.assert:
        that:
          # Check that the task didn't make any changes
          - memory_result.changed == false

          # Check overall result
          - memory_result.ansible_facts.memory_health_checks.result == "FAIL"

          # Check memory utilization
          - memory_result.ansible_facts.memory_health_checks.memory_utilization is defined
          - memory_result.ansible_facts.memory_health_checks.memory_utilization.status == "PASS"
          - memory_result.ansible_facts.memory_health_checks.memory_utilization.current_utilization is defined
          - memory_result.ansible_facts.memory_health_checks.memory_utilization.current_utilization >= 80.0
          # Check memory free
          - memory_result.ansible_facts.memory_health_checks.memory_free is defined
          - memory_result.ansible_facts.memory_health_checks.memory_free.status == "FAIL"
          - memory_result.ansible_facts.memory_health_checks.memory_free.current_free is defined
          - memory_result.ansible_facts.memory_health_checks.memory_free.current_free <= 100.0
          # Check memory buffers
          - memory_result.ansible_facts.memory_health_checks.memory_buffers is defined
          - memory_result.ansible_facts.memory_health_checks.memory_buffers.status == "FAIL"
          - memory_result.ansible_facts.memory_health_checks.memory_buffers.current_buffers is defined
          - memory_result.ansible_facts.memory_health_checks.memory_buffers.current_buffers <= 50.0

          # Check memory cache
          - memory_result.ansible_facts.memory_health_checks.memory_cache is defined
          - memory_result.ansible_facts.memory_health_checks.memory_cache.status == "FAIL"
          - memory_result.ansible_facts.memory_health_checks.memory_cache.current_cache is defined
          - memory_result.ansible_facts.memory_health_checks.memory_cache.current_cache <= 50.0

- name: Ending Memory health check integration tests
  ansible.builtin.debug:
    msg: "END network.healthchecks.memory health check integration tests on connection={{ ansible_connection }}"
