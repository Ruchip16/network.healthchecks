---
- name: Include validation tasks (ensure platform is supported)
  ansible.builtin.include_tasks: validation.yml

- name: Include OS-specific CPU tasks {{ ansible_network_os.split('.')[2] }}
  ansible.builtin.include_tasks: ./{{ ansible_network_os.split('.')[2] }}.yml

- name: Assert CPU utilization threshold
  ansible.builtin.assert:
    that:
      - cpu_utilization <= (cpu_threshold | int)
    fail_msg: "CPU utilization {{ cpu_utilization }}% exceeds threshold ({{ cpu_threshold }}%)."
    success_msg: "CPU utilization {{ cpu_utilization }}% is within acceptable limits."
  vars:
    cpu_threshold: "{{ lookup('vars', 'cpu_threshold') | default(80) }}"
  when: cpu_utilization is defined
